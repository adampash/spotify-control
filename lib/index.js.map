{"version":3,"sources":["../src/index.js"],"names":["SpotifyWebApi","require","moment","getAccessToken","refreshAccessToken","spotifyApi","REFRESHED_TOKEN","retryWithRefresh","fn","args","loadedFn","e","console","log","spotifyClient","token","setAccessToken","selectDevice","device","client","result","transferMyPlayback","deviceIds","id","startDevice","deviceName","response","getMyDevices","body","devices","stereo","find","name","toLowerCase","startsWith","process","env","STEREO","toggleError","toggleDevice","local","LOCAL","is_active","getPlaylist","playlistName","userId","getMe","items","playlists","getUserPlaylists","playlist","getMonthlyPlaylistName","format","getMonthlyPlaylist","monthlyPlaylistName","addToMonthlyPlaylist","item","uri","trackUri","getMyCurrentPlayingTrack","playlistId","tracks","getPlaylistTracks","track","addTracksToPlaylist","setVolume","percent","pause","options","play","module","exports"],"mappings":"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","file":"index.js","sourcesContent":["const SpotifyWebApi = require('spotify-web-api-node');\nconst moment = require('moment');\nconst { getAccessToken, refreshAccessToken } = require('./auth');\n\nconst spotifyApi = new SpotifyWebApi();\nlet REFRESHED_TOKEN = false;\nconst retryWithRefresh = fn => async (...args) => {\n  const loadedFn = () => fn(...args);\n  try {\n    return await loadedFn();\n  } catch (e) {\n    console.log(`ERROR on first try`, e);\n    if (REFRESHED_TOKEN) return;\n    console.log('Trying to refresh token');\n    REFRESHED_TOKEN = true;\n    await refreshAccessToken();\n    return await loadedFn();\n  }\n};\n\nconst spotifyClient = async () => {\n  try {\n    const token = await getAccessToken();\n    await spotifyApi.setAccessToken(token);\n    return spotifyApi;\n  } catch (e) {\n    console.log(`ERROR setting up client`, e);\n  }\n};\n\nconst selectDevice = async device => {\n  try {\n    const client = await spotifyClient();\n    const result = await client.transferMyPlayback({\n      deviceIds: [device.id],\n    });\n  } catch (e) {\n    console.log(`Error in selectDevice`, e);\n  }\n};\n\nconst startDevice = retryWithRefresh(async deviceName => {\n  try {\n    const client = await spotifyClient();\n    const response = await client.getMyDevices();\n    const {\n      body: { devices },\n    } = response;\n    const stereo = devices.find(({ name }) =>\n      name.toLowerCase().startsWith(deviceName || process.env.STEREO)\n    );\n    selectDevice(stereo);\n  } catch (toggleError) {\n    console.log(`toggleError`, toggleError);\n    throw toggleError;\n  }\n});\n\nconst toggleDevice = retryWithRefresh(async () => {\n  try {\n    const client = await spotifyClient();\n    const response = await client.getMyDevices();\n    const {\n      body: { devices },\n    } = response;\n    const stereo = devices.find(({ name }) =>\n      name.toLowerCase().startsWith(process.env.STEREO)\n    );\n    const local = devices.find(({ name }) =>\n      name.toLowerCase().startsWith(process.env.LOCAL)\n    );\n    selectDevice(local.is_active ? stereo : local);\n  } catch (toggleError) {\n    console.log(`toggleError`, toggleError);\n    throw toggleError;\n  }\n});\n\nconst getPlaylist = retryWithRefresh(\n  async (playlistName = 'Discover Weekly') => {\n    const client = await spotifyClient();\n    const {\n      body: { id: userId },\n    } = await client.getMe();\n    const {\n      body: { items: playlists },\n    } = await client.getUserPlaylists(userId);\n    const playlist = playlists.find(({ name }) => playlistName === name);\n    if (!playlist) {\n      console.log('No playlist with that name exits');\n      console.log('Here are your playlists');\n      console.log(playlists);\n      return;\n    }\n    console.log(playlist.id);\n    return playlist.id;\n  }\n);\n\nconst getMonthlyPlaylistName = () => moment().format('MMMM YYYY');\nconst getMonthlyPlaylist = retryWithRefresh(async userId => {\n  const monthlyPlaylistName = getMonthlyPlaylistName()\n  const id = await getPlaylist(monthlyPlaylistName);\n  return id;\n});\n\nconst addToMonthlyPlaylist = retryWithRefresh(async () => {\n  const client = await spotifyClient();\n  const {\n    body: {\n      item: { uri: trackUri },\n    },\n  } = await client.getMyCurrentPlayingTrack();\n  const {\n    body: { id: userId },\n  } = await client.getMe();\n  const {\n    body: { items: playlists },\n  } = await client.getUserPlaylists(userId);\n  const playlistId = await getMonthlyPlaylist(userId);\n  const {\n    body: { items: tracks },\n  } = await client.getPlaylistTracks(userId, playlistId);\n  if (tracks.find(({ track: { uri } }) => uri === trackUri)) return;\n  await client.addTracksToPlaylist(userId, playlistId, [trackUri]);\n});\n\nconst setVolume = retryWithRefresh(async (percent = 25) => {\n  const client = await spotifyClient();\n  await client.setVolume(percent);\n});\n\nconst pause = retryWithRefresh(async (options = {}) => {\n  const client = await spotifyClient();\n  await client.pause(options);\n});\nconst play = retryWithRefresh(async (options = {}) => {\n  const client = await spotifyClient();\n  await client.play(options);\n});\n\nmodule.exports = {\n  'toggle-device': toggleDevice,\n  play: play,\n  pause: pause,\n  'start-device': startDevice,\n  'set-volume': setVolume,\n  'add-to-monthly-playlist': addToMonthlyPlaylist,\n  'get-monthly-playlist': getMonthlyPlaylist,\n  'get-monthly-playlist-name': getMonthlyPlaylistName,\n  'get-playlist': getPlaylist,\n};\n"]}